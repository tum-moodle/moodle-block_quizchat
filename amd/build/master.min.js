define("block_quizchat/master",["exports","core/ajax","core/toast","jquery","block_quizchat/load-mathjax","block_quizchat/instructor","core/str","core/user_date"],(function(_exports,_ajax,_toast,_jquery,_loadMathjax,Instructor,_str,_user_date){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * JavaScript library for the block_quizchat plugin.
   *
   * @package
   * @copyright 2023, TUM ProLehre | Medien und Didaktik <moodle@tum.de>
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.write_sessionStorage=_exports.reset_poll_timeout=_exports.quizchat_users=_exports.quizchat_student_question_id=_exports.quizchat_msg=_exports.quizchat_general_question_id=_exports.quizchat_address_question_group=_exports.quizchat_address_instructors=_exports.quizchat_address_everyone=_exports.push_quizchat_users=_exports.poll_messages=_exports.no_drawer=_exports.lang_strings=_exports.int_sessionStorage=_exports.init=_exports.full_screen_flag=void 0,_jquery=_interopRequireDefault(_jquery),Instructor=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Instructor),_user_date=_interopRequireDefault(_user_date);var poll_timeout_id,unnotify_timeout,unnotify_timeout_id,poll_timeout=1e4,quizchatid=0,quizchat_userid=0;let processedDates={};var quizchat_msg={messages:[]};_exports.quizchat_msg=quizchat_msg;var quizchat_users=[];_exports.quizchat_users=quizchat_users;const push_quizchat_users=function(){let users=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],new_users=users.filter((u=>{let i=quizchat_users.findIndex((qc_u=>qc_u.id===u.id));if(-1===i)return u;[quizchat_address_everyone,quizchat_address_instructors].includes(i)||void 0!==u.state&&(quizchat_users[i]=u)}));quizchat_users.push(...new_users)};_exports.push_quizchat_users=push_quizchat_users;const enrolled_states=["abandoned","inprogress","noattempt","finished"];var page_reloaded=!0,most_recent_msg_id=0;let lang_strings={};_exports.lang_strings=lang_strings;const quizchat_address_everyone=0;_exports.quizchat_address_everyone=quizchat_address_everyone;const quizchat_address_instructors=-1;_exports.quizchat_address_instructors=quizchat_address_instructors;_exports.quizchat_address_question_group=-2;_exports.quizchat_student_question_id=-1;_exports.quizchat_general_question_id=0;var full_screen_flag,no_drawer=!1;_exports.no_drawer=no_drawer,_exports.full_screen_flag=full_screen_flag;_exports.reset_poll_timeout=()=>{clearTimeout(poll_timeout_id),poll_messages(quizchatid)};const int_sessionStorage=key=>{let val=sessionStorage.getItem("moodle_qc_"+quizchat_userid+"_"+quizchatid+"_"+key);return null===val?0:parseInt(val)};_exports.int_sessionStorage=int_sessionStorage;const write_sessionStorage=(key,val)=>{sessionStorage.setItem("moodle_qc_"+quizchat_userid+"_"+quizchatid+"_"+key,val)};_exports.write_sessionStorage=write_sessionStorage;const poll_messages=quizchatid=>{most_recent_msg_id=int_sessionStorage("latest_msg_id");const followUp=data=>{if(-1!==data.stats.msg_total){let total_unread_msg=int_sessionStorage("total_unread_msg"),diff=data.messages.filter((msg=>most_recent_msg_id<msg.id)).length;total_unread_msg+=data.messages.filter((msg=>most_recent_msg_id<msg.id&&msg.userid!==quizchat_userid)).length,write_sessionStorage("total_unread_msg",total_unread_msg),most_recent_msg_id<data.messages[data.messages.length-1].id||page_reloaded?(_exports.quizchat_msg=quizchat_msg=data,page_reloaded?(page_reloaded=!1,update_msg_area(data.messages.length)):update_msg_area(diff),update_notification(data.messages[data.messages.length-1]),write_sessionStorage("latest_msg_id",quizchat_msg.messages[quizchat_msg.messages.length-1].id)):(_exports.quizchat_msg=quizchat_msg=data,update_message_headers())}},calls=[{methodname:"block_quizchat_get_messages",args:{quizchatid:quizchatid,most_recent_msg_id:0,langstr_general:lang_strings.student_question_general,langstr_group:lang_strings.group_txt,langstr_attempt:lang_strings.quiz_attempt_txt,langstr_all:lang_strings.everyone}}];(0,_ajax.call)(calls)[0].then((data=>{if(0<data.stats.msg_total){data.messages.sort(((a,b)=>a.timestamp>b.timestamp));let userdata=[];const usersMap=new Map;data.messages.forEach((message=>{usersMap.has(message.userid)||usersMap.set(message.userid,{id:message.userid,lastname:message.lastname,firstname:message.firstname,fullname:message.fullname,profileimageurlsmall:message.picture,state:message.state})})),data.messages.forEach((message=>{-2!=message.receiverid?usersMap.has(message.receiverid)||usersMap.set(message.receiverid,{id:message.receiverid,lastname:message.rlastname,firstname:message.rfirstname,fullname:message.rfullname}):usersMap.has(message.receiverid)||usersMap.set(message.receiverid+"/"+message.rfullname,{id:message.receiverid+"/"+message.rfullname,lastname:message.rlastname,firstname:message.rfirstname,fullname:message.rfullname})})),userdata=Array.from(usersMap.values()),0<userdata.length?(push_quizchat_users(userdata),followUp(data)):followUp(data)}else 0>data.stats.msg_total&&followUp(data)})),poll_timeout_id=setTimeout(poll_messages,poll_timeout,quizchatid)};_exports.poll_messages=poll_messages;const update_msg_area=diff=>{let new_msg_user,new_msg_receiver,card_flavor,new_msg_el,msg_time,new_msg=quizchat_msg.messages.slice(quizchat_msg.messages.length-diff),profimg="";if(0<diff){var datesCachePromise=_jquery.default.Deferred().resolve({}).promise(),timestampsToFormat=new_msg.map((function(msg){return msg.timestamp}));timestampsToFormat.length&&(datesCachePromise=(0,_str.get_string)("strftimerecentfull","langconfig").then((function(format){var requests=timestampsToFormat.map((function(timestamp){return{timestamp:timestamp,format:format}}));return _user_date.default.get(requests)})).then((function(formattedTimes){return timestampsToFormat.reduce((function(carry,timestamp,index){return carry[timestamp]=formattedTimes[index],carry}),{})}))),datesCachePromise.then((function(datesCache){for(let i=0;i<new_msg.length;i++){new_msg_user=quizchat_users.find((u=>u.id==new_msg[i].userid)),new_msg_receiver=-2==new_msg[i].receiverid?quizchat_users.find((u=>u.id==new_msg[i].receiverid+"/"+new_msg[i].rfullname)):quizchat_users.find((u=>u.id==new_msg[i].receiverid)),card_flavor=new_msg[i].userid===quizchat_userid?"bg-secondary":"bg-light border border-secondary"+(most_recent_msg_id<new_msg[i].id?" font-weight-bolder":""),new_msg_el=(0,_jquery.default)('<div class="card block_quizchat_msg_el '+card_flavor+' mb-1" data-msg-id="'+new_msg[i].id+'"></div>'),msg_time=new Date(1e3*new_msg[i].timestamp),profimg='<div class="imgcontainer"><img class="rounded profileimg" src="'+new_msg_user.profileimageurlsmall+'" alt="'+new_msg_user.fullname+'" title="'+new_msg_user.fullname+'"></img></div>';let dateKey=datesCache[new_msg[i].timestamp].split(",").slice(0,2).join(","),displayDate=isToday(new_msg[i].timestamp)?lang_strings.today:dateKey;if(!processedDates[displayDate]){let dateDiv=(0,_jquery.default)('<div class="line-with-text" id="'+displayDate+'"><hr><span>'+displayDate+"</span><hr></div>");(0,_jquery.default)("#block_quizchat_messages > .block_quizchat_msg_area_body").append(dateDiv),processedDates[displayDate]=displayDate}(0,_jquery.default)(new_msg_el).append((0,_jquery.default)('<div class="card-header"></div>').append((0,_jquery.default)('<div class="msg-header p-0"></div>').append((0,_jquery.default)('<div class="block_quizchat_user_icon">').append(profimg),(0,_jquery.default)('<div class="text-right tofrom from">'+lang_strings.from+":</div>"),(0,_jquery.default)('<div class="fullname text-truncate" data-address-type="from" title="'+new_msg_user.fullname+'">'+new_msg_user.fullname+"</div>"),(0,_jquery.default)('<div class="timestamp text-right">'+msg_time.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+"</div>"),(0,_jquery.default)('<div class="text-right tofrom to">'+lang_strings.to+":</div>"),(0,_jquery.default)('<div class="fullname text-truncate" data-address-type="to" title="'+new_msg_receiver.fullname+'">'+new_msg_receiver.fullname+"</div>"))),(0,_jquery.default)('<div class="card-body"><div class="question-info"><b>'+lang_strings.student_question_select+" "+new_msg[i].questiontxt+new_msg[i].quizattempt+'</b></div><div class="msg-txt">'+new_msg[i].message+"</div></div>")),(0,_jquery.default)("#block_quizchat_messages > .block_quizchat_msg_area_body").append(new_msg_el),i==new_msg.length-1&&((0,_loadMathjax.queue_typeset)("card-body"),(0,_jquery.default)(".block_quizchat_msg_area_body").scrollTop((0,_jquery.default)(".block_quizchat_msg_area_body")[0].scrollHeight))}update_unnotify_timeout(),update_message_headers(),(0,Instructor.update_user_select_status_indicators)()}))}},update_notification=msg=>{let total_unread_msg=int_sessionStorage("total_unread_msg");if(quizchat_userid!==msg.userid&&0<total_unread_msg){let diff_string=total_unread_msg+" "+(1<total_unread_msg||0==total_unread_msg?lang_strings.notification_new_msg_plural:lang_strings.notification_new_msg_singular);(0,_jquery.default)(".toast").remove(),(0,_toast.add)(msg.message,{type:"info",title:diff_string,subtitle:lang_strings.from+": "+quizchat_users.find((u=>u.id===msg.userid)).fullname,closeButton:!0,autohide:!1,delay:1e4}).then((()=>{no_drawer||full_screen_flag||update_toast_style((0,_jquery.default)("#theme_boost-drawers-blocks")[0]),(0,_loadMathjax.queue_typeset)("toast-wrapper")})),(0,_jquery.default)("#block_quizchat_messages > .block_quizchat_msg_area_header").text(diff_string),full_screen_flag||((0,_jquery.default)("#new_msg_icon").remove(),(0,_jquery.default)(".drawer-toggler.drawer-right-toggle").prepend((0,_jquery.default)('<img src="'+M.cfg.wwwroot+'/blocks/quizchat/img/icon-new-message-30.png"id="new_msg_icon" alt="'+diff_string+'" title="'+diff_string+'"></img>')))}},isToday=date=>{let today=new Date,checkDate=new Date(1e3*date);return today.setHours(0,0,0,0),checkDate.setHours(0,0,0,0),today.getTime()===checkDate.getTime()},unnotify=()=>{write_sessionStorage("total_unread_msg",0),(0,_jquery.default)(".toast").remove(),(0,_jquery.default)(".block_quizchat_msg_el.font-weight-bolder").removeClass("font-weight-bolder"),(0,_jquery.default)("#block_quizchat_messages > .block_quizchat_msg_area_header").text("0 "+lang_strings.notification_new_msg_plural),(0,_jquery.default)("#new_msg_icon").remove()},update_toast_style=drawer=>{let button=document.querySelector('[data-toggler="drawers"][data-target="theme_boost-drawers-blocks"][data-action="toggle"]'),offset=0;no_drawer||(offset=drawer.classList.contains("show")?drawer.offsetWidth+15:button.parentNode.offsetWidth+15),(0,_jquery.default)(".toast").removeClass("mx-auto"),(0,_jquery.default)(".toast").css({position:"absolute",right:offset,width:"350","max-width":"350"}),(0,_jquery.default)(".toast .toast-subtitle.ml-auto.small").css({"white-space":"nowrap","max-width":"200px",overflow:"hidden","text-overflow":"ellipsis","text-align":"right"}),(0,_jquery.default)(".toast .toast-message").css({"white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis"}),(0,_jquery.default)(".toast-wrapper").removeClass(["mx-auto","fixed-top"]),(0,_jquery.default)(".toast-wrapper").css({position:"absolute",width:"350","max-width":"350",right:"0"})},update_message_headers=()=>{(0,_jquery.default)(".block_quizchat_msg_el").each((function(i,el){let msg;msg=1==quizchat_msg.messages.length?quizchat_msg.messages[0]:quizchat_msg.messages.find((m=>m.id===parseInt(el.getAttribute("data-msg-id"))));let msg_user=quizchat_users.find((u=>u.id===msg.userid));if(msg.userid!==quizchat_userid){let fullname_th=(0,_jquery.default)('div.fullname[data-address-type="from"]',(0,_jquery.default)(el));if(fullname_th.empty(),enrolled_states.includes(msg_user.state))if(fullname_th.removeClass("fullname_suspended"),Instructor.is_teacher){let questiontxt=(0,_jquery.default)(msg.questiontxt).text();fullname_th.html(((userid,fullname,questionid,questiontxt)=>{let respond_link=document.createElement("a");return respond_link.setAttribute("href","#"+userid+"/"+questionid+"/"+questiontxt),respond_link.append(document.createTextNode(fullname)),respond_link.addEventListener("click",Instructor.autofill_users_select),respond_link})(msg.userid,msg_user.fullname,msg.questionid,questiontxt))}else fullname_th.text(msg_user.fullname);else["suspended","deleted","unenrolled"].includes(msg_user.state)&&fullname_th.addClass("fullname_suspended"),fullname_th.text(msg_user.fullname)}if(Instructor.is_teacher){(0,_jquery.default)("div.imgcontainer div.statecircle-base",(0,_jquery.default)(el)).length<=0&&(0,_jquery.default)("div.imgcontainer",(0,_jquery.default)(el)).append('<div class="statecircle-base"></div>');let state_indicator=(0,_jquery.default)("div.imgcontainer div.statecircle-base",(0,_jquery.default)(el));state_indicator.attr("title",lang_strings[msg_user.state]),state_indicator.removeClass(),state_indicator.addClass("statecircle-base "+msg_user.state)}}))},drawer_mutation_callback=mutation=>{(0,_jquery.default)(".block_quizchat_msg_area_body").scrollTop((0,_jquery.default)(".block_quizchat_msg_area_body")[0].scrollHeight),update_unnotify_timeout(),update_toast_style(mutation[0].target)},update_unnotify_timeout=()=>{full_screen_flag||no_drawer||(0,_jquery.default)("#theme_boost-drawers-blocks")[0].classList.contains("show")?unnotify_timeout_id=setTimeout(unnotify,unnotify_timeout):clearTimeout(unnotify_timeout_id)};_exports.init=(arg_quizchat,arg_userid,setting_poll_timeout,setting_unnotify_timeout,no_drawer_flag,langstr_obj,fullscreen_flag)=>{_exports.no_drawer=no_drawer=no_drawer_flag,_exports.full_screen_flag=full_screen_flag=fullscreen_flag,quizchat_userid=arg_userid,_exports.lang_strings=lang_strings={...langstr_obj},function(){let users=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];_exports.quizchat_users=quizchat_users=[{id:quizchat_address_everyone,lastname:lang_strings.everyone,firstname:"("+lang_strings.group+")",fullname:lang_strings.everyone,state:"finished"},{id:quizchat_address_instructors,lastname:lang_strings.instructors,firstname:"("+lang_strings.group+")",fullname:lang_strings.instructors,state:"finished"}],Array.isArray(users)&&0<users.length&&quizchat_users.push(...users.filter((u=>{if(![0,1].includes(u.id))return u})))}();const drawer_blocks=(0,_jquery.default)("#theme_boost-drawers-blocks"),obs_config={attributes:!0,attributeFilter:["class"]},drawer_blocks_observer=new MutationObserver(drawer_mutation_callback);poll_timeout=1e3*setting_poll_timeout,unnotify_timeout=1e3*setting_unnotify_timeout,no_drawer||full_screen_flag||drawer_blocks_observer.observe(drawer_blocks[0],obs_config),quizchatid=arg_quizchat.id,poll_messages(quizchatid)}}));

//# sourceMappingURL=master.min.js.map