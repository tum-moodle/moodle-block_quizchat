define("block_quizchat/settings",["exports","core/ajax","core/notification","core/str","block_quizchat/chars_limit","jquery","core/modal_events"],(function(_exports,_ajax,Notification,Str,_chars_limit,_jquery,ModalEvents){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * JavaScript library for the block_quizchat plugin.
   *
   * @package
   * @copyright 2023, TUM ProLehre | Medien und Didaktik <moodle@tum.de>
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireWildcard(_ajax),Notification=_interopRequireWildcard(Notification),Str=_interopRequireWildcard(Str),_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj},ModalEvents=_interopRequireWildcard(ModalEvents);let msglen,titlelen,isInitialised=!1,templatesMap={},currentSort={column:1,asc:!0};const init=()=>{isInitialised||(isInitialised=!0,waitForElement("#quizchat-temp-msgs",(()=>{onFormOpen()})),(0,_jquery.default)(document).on(ModalEvents.shown,(()=>{waitForElement("#quizchat-temp-msgs",(()=>{onFormOpen()}))})))};_exports.init=init;const waitForElement=(selector,callback)=>{if(document.querySelector(selector))callback();else{const observer=new MutationObserver((()=>{document.querySelector(selector)&&(observer.disconnect(),callback())}));observer.observe(document.body,{childList:!0,subtree:!0})}},onFormOpen=()=>{initQuiztempmsgsDiv();const tabs=document.querySelectorAll(".tab-link"),contents=document.querySelectorAll(".tab-content"),saveCentral=document.getElementById("quizchat-save-central");tabs.length?(tabs.forEach((tab=>{tab.dataset.bound||(tab.dataset.bound="1",tab.addEventListener("click",(()=>{tabs.forEach((t=>t.classList.remove("active"))),contents.forEach((c=>c.classList.remove("active"))),tab.classList.add("active");const target=document.getElementById(tab.dataset.target);if(tab.dataset.target)if(target.classList.add("active"),"quiztempmsgs"===tab.dataset.target){refreshTable(),resetForm();const link=document.getElementById("quizchat-createlink");document.getElementById("quizchat-form").style.display="none",link.style.display="inline"}else"centraltempmsgs"===tab.dataset.target&&refreshTable()})))})),saveCentral.dataset.bound||(saveCentral.dataset.bound="1",saveCentral.addEventListener("click",(function(e){e.preventDefault(),saveBtn_CentralTempMsg()}))),initTableHeadersLinks()):initTableHeadersLinks()},resetForm=()=>{const title=document.getElementById("quizchat-title"),msg=document.getElementById("quizchat-message"),checkbox=document.getElementById("quizchat-ckbx_enabletemp");title&&(title.value=""),msg&&(msg.value=""),checkbox&&(checkbox.checked=!0),(0,_chars_limit.resetCharsCount)(msglen,"#charCount_msg"),(0,_chars_limit.resetCharsCount)(titlelen,"#charCount_title")},sortTableByColumn=function(tbody,columnIndex){let asc=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const rows=Array.from(tbody.querySelectorAll("tr")).filter((tr=>tr.children.length>columnIndex)),direction=asc?1:-1;rows.sort(((a,b)=>{const cellA=a.children[columnIndex],cellB=b.children[columnIndex];if(!cellA||!cellB)return 0;let A=cellA.textContent.trim(),B=cellB.textContent.trim();const dA=Date.parse(A),dB=Date.parse(B);if(!isNaN(dA)&&!isNaN(dB))return(dA-dB)*direction;const nA=parseFloat(A),nB=parseFloat(B);return isNaN(nA)||isNaN(nB)?A.localeCompare(B,void 0,{numeric:!0,sensitivity:"base"})*direction:(nA-nB)*direction})),rows.forEach((row=>tbody.appendChild(row)))},rebuildTable=rows=>{const centralDiv=document.getElementById("centraltempmsgs");let tableBody,emptyMsg,activeDiv;if(centralDiv){activeDiv=document.querySelector(".tab-content.active");let tableselector="#"+activeDiv.id+" .generaltable tbody";tableBody=document.querySelector(tableselector);let emptytempid="centraltempmsgs"===activeDiv.id?"empty_temp_central":"empty_temp";emptyMsg=document.getElementById(emptytempid)}else tableBody=document.querySelector("#quizchat-temp-msgs .generaltable tbody"),emptyMsg=document.getElementById("empty_temp");tableBody&&(tableBody.innerHTML="",rows&&0!==rows.length?(rows.forEach((row=>{const tr=document.createElement("tr");if(tr.innerHTML='\n                <td class="text-center">'.concat(row[0],"</td>\n                <td>").concat(row[1],"</td>\n                <td>").concat(row[2],'</td>\n                <td class="text-center">').concat(row[3],'</td>\n                <td class="text-center">').concat(row[4],'</td>\n                <td class="text-center">').concat(row[5],"</td>\n            "),tableBody.appendChild(tr),centralDiv&&"centraltempmsgs"===activeDiv.id){if("centraltempmsgs"===activeDiv.id){const enblChkbx=tr.querySelector(".enable_cent_temp_chkbx");enblChkbx&&enblChkbx.addEventListener("change",(e=>{e.preventDefault();const id=enblChkbx.dataset.id;checkedChanged(parseInt(id))}))}}else{const editBtn=tr.querySelector(".edit_btn");editBtn&&editBtn.addEventListener("click",(e=>{e.preventDefault();const id=editBtn.dataset.id;editTemplate(id)}));const deleteBtn=tr.querySelector(".delete_btn");deleteBtn&&deleteBtn.addEventListener("click",(e=>{e.preventDefault();const id=deleteBtn.dataset.id;deleteTemplate(parseInt(id))}))}})),emptyMsg.style.display="none",tableBody.parentElement.style.display="block",initTableHeadersLinks()):(tableBody.parentElement.style.display="none",emptyMsg.style.display="block"))},initTableHeadersLinks=()=>{if(!document.querySelector("#quizchat-temp-msgs"))return;const centralDiv=document.getElementById("centraltempmsgs");let tableBody,activeDiv,table;if(centralDiv){activeDiv=document.querySelector(".tab-content.active");let tableselector="#"+activeDiv.id+" .generaltable tbody";tableBody=document.querySelector(tableselector)}else tableBody=document.querySelector("#quizchat-temp-msgs .generaltable tbody");if(centralDiv){activeDiv=document.querySelector(".tab-content.active");let tableselector="#"+activeDiv.id+" .generaltable";table=document.querySelector(tableselector)}else table=document.querySelector("#quizchat-temp-msgs .generaltable");table.querySelector("thead").querySelectorAll(".sort-asc, .sort-desc").forEach((th=>th.classList.remove("sort-asc","sort-desc")));const headers=table.querySelectorAll(".generaltable th");headers.forEach(((th,index)=>{if(0===index)return;th.classList.add("sortable"),th.dataset.bound||(th.dataset.bound="1",th.addEventListener("click",(()=>{currentSort.column===index?currentSort.asc=!currentSort.asc:(currentSort.column=index,currentSort.asc=!0),table.querySelector("thead").querySelectorAll(".sort-asc, .sort-desc").forEach((th=>th.classList.remove("sort-asc","sort-desc"))),th.classList.add(currentSort.asc?"sort-asc":"sort-desc"),sortTableByColumn(tableBody,index,currentSort.asc)})));const defaultHeader=headers[1];currentSort={column:1,asc:!0},defaultHeader.classList.add("sort-asc"),sortTableByColumn(tableBody,currentSort.column,currentSort.asc)}))},checkedChanged=id=>{const checkbox=document.querySelector(".enable_cent_temp_chkbx[data-id='".concat(id,"']"));checkbox&&(templatesMap[id]=checkbox.checked?1:0)},notify=async function(){let show_notify=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const msgstr=await Str.getString("template_saved","block_quizchat"),qc_input=document.getElementById("id_block_quizchat_quizchatid");let quizchatid=null;if(qc_input)quizchatid=parseInt(qc_input.value);else{let temp_msgs_div=document.getElementsByName("quizchat-temp-msgs-edit-form")[0];temp_msgs_div&&(quizchatid=temp_msgs_div.dataset.qcid)}if(null===quizchatid)Notification.addNotification({message:msgstr,type:"success"});else{const notice=document.getElementById("template-save-notice");if(!notice||!show_notify)return;notice.style.display="block",notice.style.opacity="1",setTimeout((()=>{notice.style.transition="opacity 0.5s",notice.style.opacity="0",setTimeout((()=>{notice.style.display="none",notice.style.transition=""}),500)}),2e3)}},refreshTable=function(){let shownotify=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const qc_input=document.getElementById("id_block_quizchat_quizchatid");let quizchatid=null;if(qc_input)quizchatid=parseInt(qc_input.value);else{let temp_msgs_div=document.getElementsByName("quizchat-temp-msgs-edit-form")[0];temp_msgs_div&&(quizchatid=temp_msgs_div.dataset.qcid)}const centralDiv=document.getElementById("centraltempmsgs");let centraltempflag,onlyenabled,activeDiv;centralDiv?(activeDiv=document.querySelector(".tab-content.active"),activeDiv&&("centraltempmsgs"===activeDiv.id?(centraltempflag=!0,onlyenabled=!1):(centraltempflag=!1,onlyenabled=null))):(centraltempflag=!1,onlyenabled=null);const calls=[{methodname:"block_quizchat_get_template_messages",args:{templateid:null,onlyenabled:onlyenabled,quizchatid:quizchatid>0?quizchatid:null,partial_name:"",centraltempflag:centraltempflag}}];(0,_ajax.call)(calls)[0].then((rows=>{rebuildTable(rows),notify(shownotify)})).catch()},saveBtn_CentralTempMsg=()=>{let templates=[];const qc_input=document.getElementById("id_block_quizchat_quizchatid");let quizchatid=null;if(qc_input)quizchatid=parseInt(qc_input.value);else{let temp_msgs_div=document.getElementsByName("quizchat-temp-msgs-edit-form")[0];temp_msgs_div&&(quizchatid=temp_msgs_div.dataset.qcid)}for(let id in templatesMap)templates.push({templateid:parseInt(id),enabled:templatesMap[id],quizchatid:quizchatid});const calls=[{methodname:"block_quizchat_exclude_central_template_messages",args:{templates:templates}}];(0,_ajax.call)(calls)[0].then((()=>{refreshTable(!0)})).catch(Notification.exception)},unnotify=()=>{const targetContainer=document.querySelector("#region-main"),notif=targetContainer.querySelector("#user-notifications");if(targetContainer&&notif){const closeButton=notif.querySelector(".btn-close");closeButton&&closeButton.click()}},editTemplate=id=>{unnotify();const title=document.getElementById("quizchat-title"),msg=document.getElementById("quizchat-message"),checkbox=document.getElementById("quizchat-ckbx_enabletemp"),link=document.getElementById("quizchat-createlink"),form=document.getElementById("quizchat-form"),updateBtn=document.getElementById("quizchat-update"),save=document.getElementById("quizchat-save"),qc_input=document.getElementById("id_block_quizchat_quizchatid");let quizchatid=null;if(qc_input)quizchatid=parseInt(qc_input.value);else{let temp_msgs_div=document.getElementsByName("quizchat-temp-msgs-edit-form")[0];temp_msgs_div&&(quizchatid=temp_msgs_div.dataset.qcid)}const calls=[{methodname:"block_quizchat_get_template_messages",args:{templateid:id,onlyenabled:!1,quizchatid:quizchatid>0?quizchatid:null,partial_name:"",centraltempflag:!1}}];(0,_ajax.call)(calls)[0].then((data=>{title.value=data[0][1].replace(/<[^>]*>/g,"").trim(),msg.value=data[0][2].replace(/<[^>]*>/g,"").trim(),checkbox.checked=data[0][7],updateBtn.dataset.id=id,save.style.display="none",updateBtn.style.display="inline-block",form.style.display="block",link.style.display="none",(0,_jquery.default)("#quizchat-message").trigger("input"),(0,_jquery.default)("#quizchat-title").trigger("input")})).catch(Notification.exception)},deleteTemplate=tempid=>{unnotify();const link=document.getElementById("quizchat-createlink"),form=document.getElementById("quizchat-form");Str.get_strings([{key:"confirm",component:"moodle"},{key:"areyousure",component:"moodle"},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done((function(strings){Notification.confirm(strings[0],strings[1],strings[2],strings[3],(function(){_ajax.default.call([{methodname:"block_quizchat_delete_template_message",args:{templateid:parseInt(tempid)}}])[0].then((function(){refreshTable(!0),resetForm(),form.style.display="none",link.style.display="inline"})).fail(Notification.exception)}))})).fail(Notification.exception)},txt_oninput=oninput_event=>{oninput_event.preventDefault(),(0,_chars_limit.checkCharsLength)(msglen,"#quizchat-message","#charCount_msg"),oninput_event.target.setCustomValidity("")},txt_onblur=onblur_event=>{onblur_event.preventDefault(),(0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-message")&&(0,_chars_limit.resetCharsCount)(msglen,"#charCount_msg"),onblur_event.target.setCustomValidity("")},title_oninput=oninput_event=>{oninput_event.preventDefault(),(0,_chars_limit.checkCharsLength)(titlelen,"#quizchat-title","#charCount_title"),oninput_event.target.setCustomValidity("")},title_onblur=onblur_event=>{onblur_event.preventDefault(),(0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-title")&&(0,_chars_limit.resetCharsCount)(titlelen,"#charCount_title"),onblur_event.target.setCustomValidity("")},initQuiztempmsgsDiv=()=>{const link=document.getElementById("quizchat-createlink"),form=document.getElementById("quizchat-form"),cancel=document.getElementById("quizchat-cancel"),save=document.getElementById("quizchat-save"),tableBody=document.querySelector("#quizchat-temp-msgs .generaltable tbody"),updateBtn=document.getElementById("quizchat-update"),msg=document.getElementById("quizchat-message"),title=document.getElementById("quizchat-title");if(link&&form){msglen=msg.dataset.msglen,titlelen=title.dataset.titlelen,link.dataset.bound||(link.dataset.bound="1",link.addEventListener("click",(function(e){e.preventDefault(),unnotify(),link.style.display="none",updateBtn.style.display="none",save.style.display="inline-block",form.style.display="block"}))),cancel.dataset.bound||(cancel.dataset.bound="1",cancel.addEventListener("click",(function(e){e.preventDefault(),resetForm(),form.style.display="none",link.style.display="inline"}))),save.dataset.bound||(save.dataset.bound="1",save.addEventListener("click",(function(e){e.preventDefault(),(async()=>{const title=document.getElementById("quizchat-title"),msg=document.getElementById("quizchat-message"),checkbox=document.getElementById("quizchat-ckbx_enabletemp"),link=document.getElementById("quizchat-createlink"),form=document.getElementById("quizchat-form"),qc_input=document.getElementById("id_block_quizchat_quizchatid");let quizchatid=null;if(qc_input)quizchatid=parseInt(qc_input.value);else{let temp_msgs_div=document.getElementsByName("quizchat-temp-msgs-edit-form")[0];temp_msgs_div&&(quizchatid=temp_msgs_div.dataset.qcid)}let requiredmsg="";if((0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-title")&&(0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-message"))return requiredmsg=await Str.getString("txtinput_required","block_quizchat"),title.setCustomValidity(requiredmsg),msg.setCustomValidity(requiredmsg),title.reportValidity(),void msg.reportValidity();if((0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-title"))return requiredmsg=await Str.getString("txtinput_required","block_quizchat"),title.setCustomValidity(requiredmsg),void title.reportValidity();if((0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-message"))return""===requiredmsg&&(requiredmsg=await Str.getString("txtinput_required","block_quizchat")),msg.setCustomValidity(requiredmsg),void msg.reportValidity();const calls=[{methodname:"block_quizchat_create_template_message",args:{title:title.value,template:msg.value,isenabled:checkbox.checked,isquizlevel:quizchatid>0,templateid:null,quizchatid:quizchatid}}];(0,_ajax.call)(calls)[0].then((data=>(resetForm(),form.style.display="none",link.style.display="inline",refreshTable(!0),data.id))).catch((()=>{link.style.display="none",form.style.display="block"}))})()}))),updateBtn.dataset.bound||(updateBtn.dataset.bound="1",updateBtn.addEventListener("click",(function(e){e.preventDefault(),(async id=>{const title=document.getElementById("quizchat-title"),msg=document.getElementById("quizchat-message"),checkbox=document.getElementById("quizchat-ckbx_enabletemp"),link=document.getElementById("quizchat-createlink"),form=document.getElementById("quizchat-form"),qc_input=document.getElementById("id_block_quizchat_quizchatid");let quizchatid=null;if(qc_input)quizchatid=parseInt(qc_input.value);else{let temp_msgs_div=document.getElementsByName("quizchat-temp-msgs-edit-form")[0];temp_msgs_div&&(quizchatid=temp_msgs_div.dataset.qcid)}let requiredmsg="";if((0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-title")&&(0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-message"))return requiredmsg=await Str.getString("txtinput_required","block_quizchat"),title.setCustomValidity(requiredmsg),msg.setCustomValidity(requiredmsg),title.reportValidity(),void msg.reportValidity();if((0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-title"))return requiredmsg=await Str.getString("txtinput_required","block_quizchat"),title.setCustomValidity(requiredmsg),void title.reportValidity();if((0,_chars_limit.handleWhiteSpaceMsg)("#quizchat-message"))return""===requiredmsg&&(requiredmsg=await Str.getString("txtinput_required","block_quizchat")),msg.setCustomValidity(requiredmsg),void msg.reportValidity();const calls=[{methodname:"block_quizchat_create_template_message",args:{title:title.value,template:msg.value,isenabled:checkbox.checked,isquizlevel:quizchatid>0,templateid:parseInt(id),quizchatid:quizchatid}}];(0,_ajax.call)(calls)[0].then((()=>{refreshTable(!0),resetForm(),form.style.display="none",link.style.display="inline"})).catch(Notification.exception)})(updateBtn.dataset.id)})));tableBody.querySelectorAll(".edit_btn").forEach((btn=>{btn.dataset.bound||(btn.dataset.bound="1",btn.addEventListener("click",(e=>{e.preventDefault();const id=btn.dataset.id;editTemplate(id)})))}));tableBody.querySelectorAll(".delete_btn").forEach((btn=>{btn.dataset.bound||(btn.dataset.bound="1",btn.addEventListener("click",(e=>{e.preventDefault();const tempid=btn.dataset.id;deleteTemplate(tempid)})))})),(0,_jquery.default)("#quizchat-title").off("input.titleHandler blur.titleHandler").on("input.titleHandler",title_oninput).on("blur.titleHandler",title_onblur),(0,_jquery.default)("#quizchat-message").off("input.msgHandler blur.msgHandler").on("input.msgHandler",txt_oninput).on("blur.msgHandler",txt_onblur)}},observer=new MutationObserver((()=>{document.getElementById("quizchat-form")&&(observer.disconnect(),init())}));observer.observe(document.body,{childList:!0,subtree:!0})}));

//# sourceMappingURL=settings.min.js.map